trigger:
- master

pool:
  name: jay

stages:
  - stage: appBuild
    displayName: "Building the app"
    jobs:
      - job: appBuildjob
        displayName: "appBuild job"
        steps:
          - task: NodeTool@0
            inputs:
              versionSource: 'spec'
              versionSpec: '16.x'

          - task: Npm@1
            displayName: "npm install task"
            inputs:
              command: 'install'
              workingDir: '$(System.DefaultWorkingDirectory)'

          - task: Npm@1
            displayName: "npm run build taks"
            inputs:
              command: 'custom'
              workingDir: '$(System.DefaultWorkingDirectory)'
              customCommand: 'run build'

          - task: PublishBuildArtifacts@1
            displayName: "publish build task"
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/build'
              ArtifactName: 'appArtifacts'
              publishLocation: 'Container'



  - stage: Deploy
    displayName: "Deploy to VM"
    jobs:
      - job: DeployJob
        displayName: "Deploy app to Azure VM"
        steps:
          # 1. Download artifacts
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'appArtifacts'
              downloadPath: '$(Pipeline.Workspace)'

          # 2. Copy artifact to VM
          - task: CopyFilesOverSSH@0
            inputs:
              sshEndpoint: 'frontend-svc'   # ADO me banao SSH Service Connection
              sourceFolder: '$(Pipeline.Workspace)/appArtifacts'
              contents: '**'
              targetFolder: '/var/www/html/'   # Static site ke liye Nginx/Apache ka root

          # 3. Restart web server (Nginx)
          - task: SSH@0
            inputs:
              sshEndpoint: 'frontend-svc'
              runOptions: 'commands'
              commands: |
                sudo systemctl restart nginx
